{% extends 'base_tailwind.html' %}

{% block title %}Approve Loans - Admin Dashboard{% endblock %}

{% block content %}
<div class="min-h-screen bg-secondary-50 py-8">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-secondary-900">Approve High-Value Loans</h1>
            <p class="text-secondary-600 mt-2">Approve loans of K6,000 and above before disbursement</p>
        </div>

        <!-- Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Pending Approvals</p>
                        <p class="text-3xl font-bold text-warning-600 mt-2">{{ total_pending }}</p>
                    </div>
                    <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-warning-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Total Amount</p>
                        <p class="text-3xl font-bold text-primary-600 mt-2">K {{ total_amount|floatformat:0 }}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-money-bill-wave text-primary-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Average Amount</p>
                        <p class="text-3xl font-bold text-info-600 mt-2">K {% if total_pending %}{{ total_amount|add:0|div:total_pending|floatformat:0 }}{% else %}0{% endif %}</p>
                    </div>
                    <div class="w-12 h-12 bg-info-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-chart-bar text-info-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pending Approvals Table -->
        <div class="bg-white rounded-xl shadow-sm border border-secondary-100 overflow-hidden">
            <div class="p-6 border-b border-secondary-100">
                <h3 class="text-lg font-semibold text-secondary-900">Loans Awaiting Approval</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-secondary-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary-600 uppercase tracking-wider">Loan ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary-600 uppercase tracking-wider">Borrower</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary-600 uppercase tracking-wider">Amount</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary-600 uppercase tracking-wider">Applied</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-secondary-600 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-secondary-200">
                        {% for approval in pending_approvals %}
                        <tr class="hover:bg-secondary-50 transition-colors duration-150">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="font-medium text-secondary-900">#{{ approval.loan.application_number }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div>
                                    <p class="font-medium text-secondary-900">{{ approval.loan.borrower.full_name }}</p>
                                    <p class="text-sm text-secondary-600">{{ approval.loan.borrower.email }}</p>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-lg font-bold text-primary-600">K {{ approval.loan.principal_amount|floatformat:2 }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-600">
                                {{ approval.requested_date|date:"M d, Y" }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex gap-2">
                                    <form method="POST" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="approval_id" value="{{ approval.id }}">
                                        <input type="hidden" name="action" value="approve">
                                        <button type="button" onclick="showApprovalModal({{ approval.id }}, 'approve')" class="px-3 py-1 bg-success-100 text-success-700 rounded hover:bg-success-200 transition-colors duration-150 text-sm font-medium">
                                            <i class="fas fa-check mr-1"></i>Approve
                                        </button>
                                    </form>
                                    <button type="button" onclick="showApprovalModal({{ approval.id }}, 'reject')" class="px-3 py-1 bg-danger-100 text-danger-700 rounded hover:bg-danger-200 transition-colors duration-150 text-sm font-medium">
                                        <i class="fas fa-times mr-1"></i>Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-secondary-500">
                                <i class="fas fa-check-circle text-4xl mb-4 text-secondary-300"></i>
                                <p>No pending approvals</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-8">
            <a href="{% url 'dashboard:admin_dashboard' %}" class="inline-flex items-center gap-2 text-secondary-600 hover:text-secondary-900 font-medium">
                <i class="fas fa-arrow-left"></i>
                Back to Admin Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Approval Modal -->
<div id="approvalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="p-6 border-b border-secondary-200">
            <h3 id="modalTitle" class="text-xl font-bold text-secondary-900">Approve Loan</h3>
        </div>
        
        <form id="approvalForm" method="POST" class="p-6">
            {% csrf_token %}
            <input type="hidden" id="approvalId" name="approval_id">
            <input type="hidden" id="action" name="action">
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-secondary-700 mb-2">Notes</label>
                <textarea name="notes" rows="4" class="w-full px-4 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Enter approval or rejection notes..."></textarea>
            </div>

            <div class="flex justify-end gap-3">
                <button type="button" onclick="closeApprovalModal()" class="px-6 py-2 border border-secondary-300 text-secondary-700 rounded-lg hover:bg-secondary-50 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" id="submitBtn" class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors duration-200">
                    Submit
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showApprovalModal(approvalId, action) {
    document.getElementById('approvalId').value = approvalId;
    document.getElementById('action').value = action;
    
    if (action === 'approve') {
        document.getElementById('modalTitle').textContent = 'Approve Loan';
        document.getElementById('submitBtn').textContent = 'Approve';
        document.getElementById('submitBtn').className = 'px-6 py-2 bg-success-600 text-white rounded-lg hover:bg-success-700 transition-colors duration-200';
    } else {
        document.getElementById('modalTitle').textContent = 'Reject Loan';
        document.getElementById('submitBtn').textContent = 'Reject';
        document.getElementById('submitBtn').className = 'px-6 py-2 bg-danger-600 text-white rounded-lg hover:bg-danger-700 transition-colors duration-200';
    }
    
    document.getElementById('approvalModal').classList.remove('hidden');
}

function closeApprovalModal() {
    document.getElementById('approvalModal').classList.add('hidden');
}

// Close modal when clicking outside
document.getElementById('approvalModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeApprovalModal();
    }
});
</script>
{% endblock %}
