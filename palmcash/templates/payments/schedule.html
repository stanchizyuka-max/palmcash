{% extends 'base_tailwind.html' %}
{% load humanize %}

{% block title %}Payment Schedule - LoanVista{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-secondary-50 to-primary-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex items-center gap-4">
                <a href="{% if loan %}{% url 'loans:detail' loan.id %}{% else %}{% url 'loans:list' %}{% endif %}" 
                   class="bg-white p-3 rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 text-secondary-600 hover:text-primary-600">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
                <div>
                    <h1 class="text-3xl font-bold text-secondary-900 flex items-center gap-2">
                        <i class="fas fa-calendar-alt text-primary-600"></i>
                        Payment Schedule
                    </h1>
                    {% if loan %}
                    <p class="text-secondary-600 mt-1">Loan: {{ loan.application_number }}</p>
                    {% endif %}
                </div>
            </div>
            
            {% if schedule %}
            <div class="flex gap-3">
                <button onclick="window.print()" 
                        class="inline-flex items-center px-4 py-2 border border-primary-500 text-primary-600 rounded-lg hover:bg-primary-50 font-medium transition-colors duration-200">
                    <i class="fas fa-print mr-2"></i>Print
                </button>
                <button onclick="exportScheduleToCSV()" 
                        class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-success-500 to-success-600 text-white rounded-lg hover:from-success-600 hover:to-success-700 font-medium shadow-lg transition-all duration-200">
                    <i class="fas fa-download mr-2"></i>Export CSV
                </button>
            </div>
            {% endif %}
        </div>

        {% if schedule %}
        
        <!-- Loan Summary -->
        <div class="bg-white rounded-xl shadow-lg border border-secondary-100 overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">Loan Summary</h2>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="text-center p-4 bg-gradient-to-br from-primary-50 to-primary-100 rounded-lg">
                        <p class="text-sm text-secondary-600 font-medium mb-1">Loan Amount</p>
                        <p class="text-2xl font-bold text-primary-600">K{{ loan.principal_amount|floatformat:0|intcomma }}</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-info-50 to-info-100 rounded-lg">
                        <p class="text-sm text-secondary-600 font-medium mb-1">Interest Rate</p>
                        <p class="text-2xl font-bold text-info-600">{{ loan.interest_rate }}% p.a.</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-warning-50 to-warning-100 rounded-lg">
                        <p class="text-sm text-secondary-600 font-medium mb-1">Loan Term</p>
                        <p class="text-2xl font-bold text-warning-600">{{ loan.term_months }} months</p>
                    </div>
                    <div class="text-center p-4 bg-gradient-to-br from-success-50 to-success-100 rounded-lg">
                        <p class="text-sm text-secondary-600 font-medium mb-1">Monthly Payment</p>
                        <p class="text-2xl font-bold text-success-600">K{{ loan.monthly_payment|floatformat:0|intcomma }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg border border-secondary-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-secondary-600 font-medium mb-1">Payments Made</p>
                        <p class="text-3xl font-bold text-success-600">{{ paid_count }}</p>
                        <p class="text-xs text-secondary-500 mt-1">out of {{ schedule|length }} payments</p>
                    </div>
                    <div class="bg-success-100 p-4 rounded-full">
                        <i class="fas fa-check-circle text-3xl text-success-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg border border-secondary-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-secondary-600 font-medium mb-1">Pending Payments</p>
                        <p class="text-3xl font-bold text-warning-600">{{ pending_count }}</p>
                        <p class="text-xs text-secondary-500 mt-1">remaining payments</p>
                    </div>
                    <div class="bg-warning-100 p-4 rounded-full">
                        <i class="fas fa-clock text-3xl text-warning-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg border border-secondary-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-secondary-600 font-medium mb-1">Overdue Payments</p>
                        <p class="text-3xl font-bold text-danger-600">{{ overdue_count }}</p>
                        <p class="text-xs text-secondary-500 mt-1">need attention</p>
                    </div>
                    <div class="bg-danger-100 p-4 rounded-full">
                        <i class="fas fa-exclamation-triangle text-3xl text-danger-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Next Payment Alert -->
        {% if next_payment %}
        <div class="{% if next_payment.is_overdue %}bg-danger-50 border-danger-500{% else %}bg-blue-50 border-blue-500{% endif %} border-l-4 p-6 mb-8 rounded-r-lg shadow-lg">
            <div class="flex items-start gap-4">
                <div class="{% if next_payment.is_overdue %}bg-danger-100{% else %}bg-blue-100{% endif %} p-3 rounded-full">
                    <i class="fas fa-{% if next_payment.is_overdue %}exclamation-triangle{% else %}info-circle{% endif %} text-2xl {% if next_payment.is_overdue %}text-danger-600{% else %}text-blue-600{% endif %}"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold {% if next_payment.is_overdue %}text-danger-800{% else %}text-blue-800{% endif %} mb-2">
                        {% if next_payment.is_overdue %}Overdue Payment Alert{% else %}Next Payment Due{% endif %}
                    </h3>
                    <p class="{% if next_payment.is_overdue %}text-danger-700{% else %}text-blue-700{% endif %} mb-3">
                        Payment #{{ next_payment.installment_number }} of K{{ next_payment.total_amount|floatformat:0|intcomma }} 
                        {% if next_payment.is_overdue %}
                        was due on {{ next_payment.due_date|date:"M d, Y" }} ({{ next_payment.days_overdue }} days ago)
                        {% else %}
                        is due on {{ next_payment.due_date|date:"M d, Y" }}
                        {% endif %}
                    </p>
                    {% if user.role == 'borrower' and user == loan.borrower %}
                    <a href="{% url 'payments:make' next_payment.loan.id %}?schedule_id={{ next_payment.id %}" 
                       class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-{% if next_payment.is_overdue %}danger{% else %}primary{% endif %}-500 to-{% if next_payment.is_overdue %}danger{% else %}primary{% endif %}-600 text-white rounded-lg hover:from-{% if next_payment.is_overdue %}danger{% else %}primary{% endif %}-600 hover:to-{% if next_payment.is_overdue %}danger{% else %}primary{% endif %}-700 font-medium shadow-lg transition-all duration-200">
                        <i class="fas fa-credit-card mr-2"></i>Make Payment Now
                    </a>
                    {% else %}
                    <p class="text-secondary-600 text-sm">
                        <i class="fas fa-info-circle mr-1"></i>Contact borrower to make payment
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Payment Schedule Table -->
        <div class="bg-white rounded-xl shadow-lg border border-secondary-100 overflow-hidden">
            <div class="bg-gradient-to-r from-secondary-700 to-secondary-800 px-6 py-4">
                <h2 class="text-xl font-semibold text-white">Payment Schedule Details</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-secondary-200">
                    <thead class="bg-secondary-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Principal</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Interest</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Penalty</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-semibold text-secondary-700 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-secondary-200">
                        {% for payment in schedule %}
                        <tr class="hover:bg-secondary-50 transition-colors duration-150 {% if payment.is_overdue %}bg-danger-50{% elif payment.is_paid %}bg-success-50{% endif %}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="font-bold text-secondary-900">{{ payment.installment_number }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-secondary-900 font-medium">{{ payment.due_date|date:"M d, Y" }}</div>
                                {% if payment.is_overdue %}
                                <div class="text-xs text-danger-600 font-semibold mt-1">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>{{ payment.days_overdue }} days overdue
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-900">K{{ payment.principal_amount|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-secondary-900">K{{ payment.interest_amount|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="text-sm font-bold text-primary-600">K{{ payment.total_amount|floatformat:0|intcomma }}</span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if payment.penalty_amount > 0 %}
                                <span class="text-sm font-semibold text-danger-600">K{{ payment.penalty_amount|floatformat:0|intcomma }}</span>
                                {% else %}
                                <span class="text-sm text-secondary-400">K0</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if payment.is_paid %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-success-100 text-success-800">
                                    <i class="fas fa-check mr-1"></i>Paid
                                </span>
                                {% if payment.paid_date %}
                                <div class="text-xs text-secondary-500 mt-1">{{ payment.paid_date|date:"M d, Y" }}</div>
                                {% endif %}
                                {% elif payment.is_overdue %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-danger-100 text-danger-800">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>Overdue
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-warning-100 text-warning-800">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                {% if not payment.is_paid and user.role == 'borrower' and user == loan.borrower %}
                                <a href="{% url 'payments:make' payment.loan.id %}?schedule_id={{ payment.id %}" 
                                   class="inline-flex items-center px-3 py-1 bg-primary-100 text-primary-700 rounded-lg hover:bg-primary-200 transition-colors duration-150 font-medium">
                                    <i class="fas fa-credit-card mr-1"></i>Pay Now
                                </a>
                                {% elif not payment.is_paid and user.role != 'borrower' %}
                                <span class="text-secondary-400 text-xs">
                                    <i class="fas fa-info-circle mr-1"></i>Borrower Only
                                </span>
                                {% else %}
                                <span class="text-secondary-400">-</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="bg-secondary-100">
                        <tr class="font-semibold">
                            <td colspan="2" class="px-6 py-4 text-secondary-900">Totals:</td>
                            <td class="px-6 py-4 text-secondary-900">K{{ total_principal|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-secondary-900">K{{ total_interest|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-primary-600 font-bold">K{{ total_amount|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4 text-danger-600">K{{ total_penalties|floatformat:0|intcomma }}</td>
                            <td class="px-6 py-4">-</td>
                            <td class="px-6 py-4">-</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-col sm:flex-row justify-between gap-4">
            <a href="{% if loan %}{% url 'loans:detail' loan.id %}{% else %}{% url 'loans:list' %}{% endif %}" 
               class="inline-flex items-center justify-center px-6 py-3 border border-secondary-300 rounded-lg text-secondary-700 bg-white hover:bg-secondary-50 font-medium transition-colors duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Back to Loan Details
            </a>
            {% if loan and user.role == 'borrower' and user == loan.borrower %}
            <a href="{% url 'payments:make' loan.id %}" 
               class="inline-flex items-center justify-center px-6 py-3 bg-gradient-to-r from-success-500 to-success-600 text-white rounded-lg hover:from-success-600 hover:to-success-700 font-medium shadow-lg hover:shadow-xl transition-all duration-200">
                <i class="fas fa-credit-card mr-2"></i>Make Payment
            </a>
            {% elif loan and user.role != 'borrower' %}
            <span class="text-secondary-500 text-sm flex items-center">
                <i class="fas fa-info-circle mr-2"></i>Only borrowers can submit payments
            </span>
            {% endif %}
        </div>

        {% else %}
        
        <!-- No Schedule Available -->
        <div class="bg-white rounded-xl shadow-lg border border-secondary-100 p-12 text-center">
            <div class="bg-secondary-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-calendar-times text-5xl text-secondary-400"></i>
            </div>
            <h2 class="text-2xl font-bold text-secondary-900 mb-3">No Payment Schedule Available</h2>
            <p class="text-secondary-600 mb-6 max-w-md mx-auto">
                This loan does not have a payment schedule yet. Payment schedules are generated when loans are disbursed.
            </p>
            <a href="{% url 'loans:list' %}" 
               class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-primary-500 to-primary-600 text-white rounded-lg hover:from-primary-600 hover:to-primary-700 font-medium shadow-lg transition-all duration-200">
                <i class="fas fa-arrow-left mr-2"></i>Back to Loans
            </a>
        </div>
        
        {% endif %}

    </div>
</div>

<style>
@media print {
    .inline-flex, button, a[href*="make"], .bg-gradient-to-br {
        display: none !important;
    }
    .bg-white {
        box-shadow: none !important;
    }
}
</style>

<script>
function exportScheduleToCSV() {
    {% if schedule %}
    const scheduleData = [
        ['Payment Schedule - {{ loan.application_number }}'],
        ['Borrower: {{ loan.borrower.full_name }}'],
        ['Loan Amount: K{{ loan.principal_amount|floatformat:2 }}'],
        ['Interest Rate: {{ loan.interest_rate }}%'],
        ['Term: {{ loan.term_months }} months'],
        ['Generated: ' + new Date().toLocaleString()],
        [],
        ['Payment #', 'Due Date', 'Principal (K)', 'Interest (K)', 'Total Payment (K)', 'Penalty (K)', 'Status', 'Paid Date']
    ];
    
    {% for payment in schedule %}
    scheduleData.push([
        '{{ payment.installment_number }}',
        '{{ payment.due_date|date:"Y-m-d" }}',
        '{{ payment.principal_amount|floatformat:2 }}',
        '{{ payment.interest_amount|floatformat:2 }}',
        '{{ payment.total_amount|floatformat:2 }}',
        '{{ payment.penalty_amount|floatformat:2 }}',
        '{% if payment.is_paid %}Paid{% elif payment.is_overdue %}Overdue{% else %}Pending{% endif %}',
        '{% if payment.paid_date %}{{ payment.paid_date|date:"Y-m-d" }}{% endif %}'
    ]);
    {% endfor %}
    
    scheduleData.push([]);
    scheduleData.push(['TOTALS', '', '{{ total_principal|floatformat:2 }}', '{{ total_interest|floatformat:2 }}', '{{ total_amount|floatformat:2 }}', '{{ total_penalties|floatformat:2 }}', '', '']);
    
    const csvContent = scheduleData.map(row => 
        row.map(cell => 
            typeof cell === 'string' && cell.includes(',') ? `"${cell}"` : cell
        ).join(',')
    ).join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'payment_schedule_{{ loan.application_number }}.csv';
    a.click();
    window.URL.revokeObjectURL(url);
    {% else %}
    alert('No payment schedule available to export');
    {% endif %}
}
</script>
{% endblock %}
