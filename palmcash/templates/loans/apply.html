{% extends 'base_tailwind.html' %}
{% load widget_tweaks %}

{% block title %}Apply for Loan - LoanVista{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-secondary-900 mb-2">
            <i class="fas fa-money-bill-wave text-primary-600 mr-3"></i>
            Apply for a Loan
        </h1>
        <p class="text-secondary-600">Choose between daily or weekly repayment at 45% interest</p>
    </div>

    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4">
            <h2 class="text-xl font-bold text-white">Loan Application Form</h2>
        </div>
        <div class="p-8">
            <!-- Eligibility Check -->
            {% if not has_verified_documents %}
            <div class="bg-warning-50 border-l-4 border-warning-500 rounded-lg p-6 mb-6">
                <h5 class="text-lg font-semibold text-warning-900 mb-2">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Document Verification Required
                </h5>
                <p class="text-warning-700 mb-3">You must have at least one verified document before applying for a loan.</p>
                <a href="{% url 'documents:list' %}" class="btn-warning">
                    <i class="fas fa-upload mr-2"></i>Upload Documents
                </a>
            </div>
            {% endif %}

            {% if user_loans and not can_apply %}
            <div class="bg-danger-50 border-l-4 border-danger-500 rounded-lg p-6 mb-6">
                <h5 class="text-lg font-semibold text-danger-900 mb-2">
                    <i class="fas fa-ban mr-2"></i>Outstanding Loans Detected
                </h5>
                <p class="text-danger-700">You cannot apply for a new loan while you have outstanding loans. Please complete your current loan payments first.</p>
            </div>
            {% endif %}
            
            <form method="post" id="loan-application-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="bg-danger-50 border border-danger-200 rounded-lg p-4 mb-6 text-danger-800">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    {{ form.non_field_errors }}
                </div>
                {% endif %}
                
                <!-- Loan Type Selection -->
                <div class="mb-6">
                    <label for="{{ form.loan_type.id_for_label }}" class="block text-sm font-semibold text-secondary-700 mb-2">
                        <i class="fas fa-list text-primary-600 mr-2"></i>Loan Type *
                    </label>
                    {{ form.loan_type|add_class:"w-full px-4 py-3 border-2 border-secondary-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors duration-200" }}
                    {% if form.loan_type.errors %}
                    <div class="text-danger-600 text-sm mt-1">{{ form.loan_type.errors }}</div>
                    {% endif %}
                    
                    <!-- Loan Type Info -->
                    <div id="loan-type-info" class="mt-3 bg-info-50 border border-info-200 rounded-lg p-4" style="display: none;">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                            <div>
                                <p class="text-info-900"><i class="fas fa-percentage mr-2"></i><strong>Interest Rate:</strong> <span id="interest-rate-info">45%</span></p>
                                <p class="text-info-900"><i class="fas fa-calendar mr-2"></i><strong>Frequency:</strong> <span id="frequency-info"></span></p>
                            </div>
                            <div>
                                <p class="text-info-900"><i class="fas fa-money-bill mr-2"></i><strong>Amount Range:</strong> <span id="amount-range-info"></span></p>
                                <p class="text-info-900"><i class="fas fa-clock mr-2"></i><strong>Term Range:</strong> <span id="term-range-info"></span></p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Loan Amount -->
                    <div>
                        <label for="{{ form.principal_amount.id_for_label }}" class="block text-sm font-semibold text-secondary-700 mb-2">
                            <i class="fas fa-money-bill-wave text-primary-600 mr-2"></i>Loan Amount (K) *
                        </label>
                        {{ form.principal_amount|add_class:"w-full px-4 py-3 border-2 border-secondary-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors duration-200" }}
                        {% if form.principal_amount.errors %}
                        <div class="text-danger-600 text-sm mt-1">{{ form.principal_amount.errors }}</div>
                        {% endif %}
                        <p class="text-xs text-secondary-500 mt-1">Enter the amount you wish to borrow</p>
                    </div>
                    
                    <!-- Loan Term -->
                    <div id="term-input-container">
                        <label id="term-label" class="block text-sm font-semibold text-secondary-700 mb-2">
                            <i class="fas fa-calendar-alt text-primary-600 mr-2"></i>Loan Term *
                        </label>
                        <input type="number" id="term-input" name="term" min="1" 
                               class="w-full px-4 py-3 border-2 border-secondary-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors duration-200"
                               placeholder="Enter term">
                        <p id="term-help" class="text-xs text-secondary-500 mt-1">Select loan type first</p>
                    </div>
                </div>
                
                <!-- Purpose -->
                <div class="mb-6">
                    <label for="{{ form.purpose.id_for_label }}" class="block text-sm font-semibold text-secondary-700 mb-2">
                        <i class="fas fa-comment-alt text-primary-600 mr-2"></i>Purpose of Loan *
                    </label>
                    {{ form.purpose|add_class:"w-full px-4 py-3 border-2 border-secondary-200 rounded-lg focus:border-primary-500 focus:ring-2 focus:ring-primary-200 transition-colors duration-200" }}
                    {% if form.purpose.errors %}
                    <div class="text-danger-600 text-sm mt-1">{{ form.purpose.errors }}</div>
                    {% endif %}
                </div>
                
                <!-- Loan Calculator -->
                <div id="loan-calculator" class="bg-gradient-to-br from-success-50 to-success-100 border-2 border-success-200 rounded-xl p-6 mb-6" style="display: none;">
                    <h3 class="text-lg font-bold text-success-900 mb-4">
                        <i class="fas fa-calculator mr-2"></i>Loan Repayment Summary
                    </h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-secondary-700">Principal Amount:</span>
                                <span class="font-bold text-secondary-900" id="calc-principal">K0</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-secondary-700">Interest (45%):</span>
                                <span class="font-bold text-warning-600" id="calc-interest">K0</span>
                            </div>
                            <div class="flex justify-between border-t-2 border-success-300 pt-2">
                                <span class="text-secondary-700 font-semibold">Total Repayment:</span>
                                <span class="font-bold text-success-700 text-lg" id="calc-total">K0</span>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-secondary-700">Repayment Frequency:</span>
                                <span class="font-bold text-secondary-900" id="calc-frequency">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-secondary-700">Number of Payments:</span>
                                <span class="font-bold text-secondary-900" id="calc-periods">0</span>
                            </div>
                            <div class="flex justify-between border-t-2 border-success-300 pt-2">
                                <span class="text-secondary-700 font-semibold">Payment Amount:</span>
                                <span class="font-bold text-primary-600 text-lg" id="calc-payment">K0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 bg-white rounded-lg p-4">
                        <p class="text-sm text-info-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Note:</strong> This is an estimate. A 10% upfront payment (K<span id="upfront-amount">0</span>) is required before disbursement.
                        </p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex justify-between items-center pt-6 border-t border-secondary-200">
                    <a href="{% url 'dashboard:home' %}" class="btn-outline-secondary">
                        <i class="fas fa-arrow-left mr-2"></i>Cancel
                    </a>
                    <button type="submit" class="btn-primary" {% if not can_apply or not has_verified_documents %}disabled{% endif %}>
                        <i class="fas fa-paper-plane mr-2"></i>Submit Application
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loanTypeSelect = document.getElementById('{{ form.loan_type.id_for_label }}');
    const principalInput = document.getElementById('{{ form.principal_amount.id_for_label }}');
    const termInput = document.getElementById('term-input');
    const termLabel = document.getElementById('term-label');
    const termHelp = document.getElementById('term-help');
    
    // Loan type data
    const loanTypeData = {
        {% for loan_type in form.fields.loan_type.queryset %}
        '{{ loan_type.id }}': {
            'name': '{{ loan_type.name }}',
            'interest_rate': {{ loan_type.interest_rate }},
            'min_amount': {{ loan_type.min_amount }},
            'max_amount': {{ loan_type.max_amount }},
            'frequency': '{{ loan_type.repayment_frequency }}',
            'min_term_days': {{ loan_type.min_term_days|default:"null" }},
            'max_term_days': {{ loan_type.max_term_days|default:"null" }},
            'min_term_weeks': {{ loan_type.min_term_weeks|default:"null" }},
            'max_term_weeks': {{ loan_type.max_term_weeks|default:"null" }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
    
    loanTypeSelect.addEventListener('change', function() {
        const selectedId = this.value;
        if (selectedId && loanTypeData[selectedId]) {
            const data = loanTypeData[selectedId];
            
            // Update loan type info
            document.getElementById('interest-rate-info').textContent = data.interest_rate + '%';
            document.getElementById('frequency-info').textContent = data.frequency.charAt(0).toUpperCase() + data.frequency.slice(1);
            document.getElementById('amount-range-info').textContent = `K${data.min_amount.toLocaleString()} - K${data.max_amount.toLocaleString()}`;
            
            // Update term input based on frequency
            if (data.frequency === 'daily') {
                termLabel.innerHTML = '<i class="fas fa-calendar-alt text-primary-600 mr-2"></i>Loan Term (Days) *';
                termInput.setAttribute('min', data.min_term_days);
                termInput.setAttribute('max', data.max_term_days);
                termInput.setAttribute('placeholder', `Enter days (${data.min_term_days}-${data.max_term_days})`);
                termHelp.textContent = `Enter number of days (${data.min_term_days} to ${data.max_term_days})`;
                document.getElementById('term-range-info').textContent = `${data.min_term_days}-${data.max_term_days} days`;
            } else if (data.frequency === 'weekly') {
                termLabel.innerHTML = '<i class="fas fa-calendar-alt text-primary-600 mr-2"></i>Loan Term (Weeks) *';
                termInput.setAttribute('min', data.min_term_weeks);
                termInput.setAttribute('max', data.max_term_weeks);
                termInput.setAttribute('placeholder', `Enter weeks (${data.min_term_weeks}-${data.max_term_weeks})`);
                termHelp.textContent = `Enter number of weeks (${data.min_term_weeks} to ${data.max_term_weeks})`;
                document.getElementById('term-range-info').textContent = `${data.min_term_weeks}-${data.max_term_weeks} weeks`;
            }
            
            document.getElementById('loan-type-info').style.display = 'block';
            calculateLoan();
        } else {
            document.getElementById('loan-type-info').style.display = 'none';
            document.getElementById('loan-calculator').style.display = 'none';
        }
    });
    
    function calculateLoan() {
        const selectedId = loanTypeSelect.value;
        const principal = parseFloat(principalInput.value) || 0;
        const term = parseInt(termInput.value) || 0;
        
        if (selectedId && loanTypeData[selectedId] && principal > 0 && term > 0) {
            const data = loanTypeData[selectedId];
            const interestAmount = principal * (data.interest_rate / 100);
            const totalAmount = principal + interestAmount;
            const paymentAmount = totalAmount / term;
            const upfrontPayment = principal * 0.10;
            
            // Update calculator
            document.getElementById('calc-principal').textContent = `K${principal.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('calc-interest').textContent = `K${interestAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('calc-total').textContent = `K${totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('calc-frequency').textContent = data.frequency.charAt(0).toUpperCase() + data.frequency.slice(1);
            document.getElementById('calc-periods').textContent = term;
            document.getElementById('calc-payment').textContent = `K${paymentAmount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            document.getElementById('upfront-amount').textContent = upfrontPayment.toLocaleString('en-US', {minimumFractionDigits: 2});
            
            document.getElementById('loan-calculator').style.display = 'block';
        } else {
            document.getElementById('loan-calculator').style.display = 'none';
        }
    }
    
    principalInput.addEventListener('input', calculateLoan);
    termInput.addEventListener('input', calculateLoan);
});
</script>
{% endblock %}
