{% extends 'base_tailwind.html' %}

{% block title %}Manage Loan Documents - LoanVista{% endblock %}

{% block content %}
<div class="min-h-screen bg-secondary-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-secondary-900">Loan Documents Management</h1>
            <p class="text-secondary-600 mt-2">Review and manage all loan-related documents</p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Total Documents</p>
                        <p class="text-3xl font-bold text-secondary-900 mt-2">{{ total_documents }}</p>
                    </div>
                    <div class="w-12 h-12 bg-primary-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-alt text-primary-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Pending Review</p>
                        <p class="text-3xl font-bold text-warning-600 mt-2">{{ pending_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-warning-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-clock text-warning-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">Verified</p>
                        <p class="text-3xl font-bold text-success-600 mt-2">{{ verified_count }}</p>
                    </div>
                    <div class="w-12 h-12 bg-success-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-check-circle text-success-600 text-xl"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm p-6 border border-secondary-100">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-secondary-600 text-sm font-medium">This Month</p>
                        <p class="text-3xl font-bold text-info-600 mt-2">{{ monthly_uploads }}</p>
                    </div>
                    <div class="w-12 h-12 bg-info-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-calendar text-info-600 text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="bg-white rounded-xl shadow-sm border border-secondary-100 mb-6">
            <div class="flex border-b border-secondary-200">
                <button onclick="filterDocuments('all')" class="filter-tab active px-6 py-4 font-medium text-sm border-b-2 border-primary-600 text-primary-600">
                    All Documents ({{ total_documents }})
                </button>
                <button onclick="filterDocuments('pending')" class="filter-tab px-6 py-4 font-medium text-sm border-b-2 border-transparent text-secondary-600 hover:text-secondary-900">
                    Pending ({{ pending_count }})
                </button>
                <button onclick="filterDocuments('verified')" class="filter-tab px-6 py-4 font-medium text-sm border-b-2 border-transparent text-secondary-600 hover:text-secondary-900">
                    Verified ({{ verified_count }})
                </button>
            </div>
        </div>

        <!-- Documents by Loan -->
        {% if loans_with_documents %}
        <div class="space-y-6">
            {% for loan_data in loans_with_documents %}
            <div class="bg-white rounded-xl shadow-sm border border-secondary-100 overflow-hidden">
                <!-- Loan Header -->
                <div class="bg-gradient-to-r from-primary-50 to-primary-100 p-6 border-b border-primary-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-lg font-bold text-secondary-900">{{ loan_data.loan.application_number }}</h3>
                            <p class="text-secondary-600 mt-1">
                                <i class="fas fa-user mr-2"></i>{{ loan_data.loan.borrower.get_full_name }}
                            </p>
                            <p class="text-secondary-600 mt-1">
                                <i class="fas fa-money-bill-wave mr-2"></i>K {{ loan_data.loan.principal_amount|floatformat:2 }}
                            </p>
                        </div>
                        <div class="text-right">
                            <span class="px-4 py-2 rounded-full text-sm font-medium
                                {% if loan_data.loan.status == 'pending' %}bg-warning-100 text-warning-800
                                {% elif loan_data.loan.status == 'approved' %}bg-success-100 text-success-800
                                {% elif loan_data.loan.status == 'active' %}bg-info-100 text-info-800
                                {% elif loan_data.loan.status == 'rejected' %}bg-danger-100 text-danger-800
                                {% else %}bg-secondary-100 text-secondary-800
                                {% endif %}">
                                {{ loan_data.loan.get_status_display }}
                            </span>
                            <p class="text-sm text-secondary-600 mt-2">
                                {{ loan_data.documents|length }} document{{ loan_data.documents|length|pluralize }}
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Documents Table -->
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-secondary-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Document Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">File Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Uploaded</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-secondary-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-secondary-200">
                            {% for doc in loan_data.documents %}
                            <tr class="hover:bg-secondary-50 transition-colors duration-150">
                                <td class="px-6 py-4">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-primary-100 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-file-alt text-primary-600"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-secondary-900">{{ doc.get_document_type_display }}</p>
                                            {% if doc.description %}
                                            <p class="text-xs text-secondary-500">{{ doc.description|truncatewords:8 }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4">
                                    <p class="text-sm text-secondary-900">{{ doc.original_filename }}</p>
                                    <p class="text-xs text-secondary-500">{{ doc.file_size_mb }} MB</p>
                                </td>
                                <td class="px-6 py-4">
                                    <p class="text-sm text-secondary-900">{{ doc.uploaded_at|date:"M d, Y" }}</p>
                                    <p class="text-xs text-secondary-500">by {{ doc.uploaded_by.get_full_name }}</p>
                                </td>
                                <td class="px-6 py-4">
                                    {% if doc.is_verified %}
                                    <div>
                                        <span class="px-3 py-1 rounded-full text-xs font-medium bg-success-100 text-success-800">
                                            <i class="fas fa-check-circle mr-1"></i>Verified
                                        </span>
                                        {% if doc.verified_by %}
                                        <p class="text-xs text-secondary-500 mt-1">by {{ doc.verified_by.get_full_name }}</p>
                                        {% endif %}
                                    </div>
                                    {% else %}
                                    <span class="px-3 py-1 rounded-full text-xs font-medium bg-warning-100 text-warning-800">
                                        <i class="fas fa-clock mr-1"></i>Pending
                                    </span>
                                    {% endif %}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="flex items-center gap-2">
                                        <a href="{% url 'loans:download_document' doc.id %}" class="text-primary-600 hover:text-primary-800 p-2 hover:bg-primary-50 rounded transition-colors duration-150" title="Download">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        {% if not doc.is_verified %}
                                        <button onclick="verifyDocument({{ doc.id }})" class="text-success-600 hover:text-success-800 p-2 hover:bg-success-50 rounded transition-colors duration-150" title="Verify">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        {% endif %}
                                        <button onclick="viewDetails({{ doc.id }})" class="text-info-600 hover:text-info-800 p-2 hover:bg-info-50 rounded transition-colors duration-150" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <form method="POST" action="{% url 'loans:admin_delete_document' doc.id %}" class="inline" onsubmit="return confirm('Are you sure you want to delete this document? This action cannot be undone.');">
                                            {% csrf_token %}
                                            <button type="submit" class="text-danger-600 hover:text-danger-800 p-2 hover:bg-danger-50 rounded transition-colors duration-150" title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-white rounded-xl shadow-sm border border-secondary-100 p-12 text-center">
            <i class="fas fa-file-alt text-6xl text-secondary-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-secondary-900 mb-2">No Documents Found</h3>
            <p class="text-secondary-600">No loan documents have been uploaded yet.</p>
        </div>
        {% endif %}

        <!-- Back Button -->
        <div class="mt-8">
            <a href="{% url 'dashboard:admin' %}" class="inline-flex items-center gap-2 text-secondary-600 hover:text-secondary-900 font-medium">
                <i class="fas fa-arrow-left"></i>
                Back to Admin Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div id="verifyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="p-6 border-b border-secondary-200">
            <h3 class="text-xl font-bold text-secondary-900">Verify Document</h3>
        </div>
        
        <form id="verifyForm" method="POST" class="p-6">
            {% csrf_token %}
            <input type="hidden" id="documentId" name="document_id">
            <input type="hidden" name="is_verified" value="true">
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-secondary-700 mb-2">Verification Notes</label>
                    <textarea name="verification_notes" rows="4" class="w-full px-4 py-2 border border-secondary-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="Add any notes about this verification..."></textarea>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-secondary-200">
                <button type="button" onclick="closeVerifyModal()" class="px-6 py-2 border border-secondary-300 text-secondary-700 rounded-lg hover:bg-secondary-50 transition-colors duration-200">
                    Cancel
                </button>
                <button type="submit" class="px-6 py-2 bg-success-600 text-white rounded-lg hover:bg-success-700 transition-colors duration-200">
                    <i class="fas fa-check mr-2"></i>Verify Document
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function filterDocuments(filter) {
    // Remove active class from all tabs
    document.querySelectorAll('.filter-tab').forEach(tab => {
        tab.classList.remove('active', 'border-primary-600', 'text-primary-600');
        tab.classList.add('border-transparent', 'text-secondary-600');
    });
    
    // Add active class to clicked tab
    event.target.classList.add('active', 'border-primary-600', 'text-primary-600');
    event.target.classList.remove('border-transparent', 'text-secondary-600');
    
    // TODO: Implement filtering logic
    console.log('Filter by:', filter);
}

function verifyDocument(id) {
    document.getElementById('documentId').value = id;
    document.getElementById('verifyForm').action = `/loans/documents/${id}/verify/`;
    document.getElementById('verifyModal').classList.remove('hidden');
}

function closeVerifyModal() {
    document.getElementById('verifyModal').classList.add('hidden');
}

function viewDetails(id) {
    // TODO: Implement view details modal
    console.log('View details for document:', id);
}

// Close modal when clicking outside
document.getElementById('verifyModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeVerifyModal();
    }
});
</script>
{% endblock %}
