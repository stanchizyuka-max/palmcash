{% extends 'base_tailwind_enhanced.html' %}
{% load static %}
{% load humanize %}

{% block title %}Loan Application Details - {{ loan.application_number }} - Palm Cash{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-green-50 to-slate-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl font-bold text-slate-900 mb-2">
                        <i class="fas fa-file-contract text-green-600 mr-3"></i>
                        Loan Application
                    </h1>
                    <p class="text-lg text-slate-600">Application #<span class="font-semibold">{{ loan.application_number }}</span></p>
                </div>
                <a href="{% url 'loans:detail' loan.pk %}" class="inline-flex items-center px-6 py-3 bg-white border-2 border-green-600 text-green-600 rounded-lg hover:bg-green-50 transition-colors duration-200 font-semibold shadow-md">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Loan
                </a>
            </div>
        </div>

        <!-- Status Card -->
        <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 mb-8 border-l-4 
            {% if loan.status == 'pending' %}border-l-yellow-500
            {% elif loan.status == 'approved' %}border-l-green-500
            {% elif loan.status == 'active' %}border-l-blue-500
            {% elif loan.status == 'rejected' %}border-l-red-500
            {% elif loan.status == 'completed' %}border-l-slate-500
            {% endif %}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Status</p>
                    <div class="inline-flex items-center px-4 py-2 rounded-lg font-semibold
                        {% if loan.status == 'pending' %}bg-yellow-100 text-yellow-800
                        {% elif loan.status == 'approved' %}bg-green-100 text-green-800
                        {% elif loan.status == 'active' %}bg-blue-100 text-blue-800
                        {% elif loan.status == 'rejected' %}bg-red-100 text-red-800
                        {% elif loan.status == 'completed' %}bg-slate-100 text-slate-800
                        {% endif %}">
                        <i class="fas fa-circle mr-2 text-xs"></i>
                        {{ loan.get_status_display }}
                    </div>
                </div>
                <div>
                    <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Applied On</p>
                    <p class="text-2xl font-bold text-slate-900">{{ loan.application_date|date:"M d, Y" }}</p>
                </div>
                <div>
                    <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Time Elapsed</p>
                    <p class="text-2xl font-bold text-slate-900">
                        {% widthratio loan.application_date|date:"U" "now"|date:"U" 86400 %}
                        days
                    </p>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Loan Details Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-blue-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-file-invoice-dollar text-blue-600 mr-3"></i>
                        Loan Details
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Loan Type</p>
                                <p class="text-xl font-bold text-slate-900">{{ application_details.loan_type }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Principal Amount</p>
                                <p class="text-3xl font-bold text-blue-600">K{{ application_details.principal_amount|floatformat:0 }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Interest Rate</p>
                                <p class="text-xl font-bold text-slate-900">{{ application_details.interest_rate }}% per annum</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Repayment Frequency</p>
                                <p class="text-xl font-bold text-slate-900">{{ application_details.repayment_frequency }}</p>
                            </div>
                            {% if application_details.term_days %}
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Loan Term</p>
                                <p class="text-xl font-bold text-slate-900">{{ application_details.term_days }} days</p>
                            </div>
                            {% endif %}
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Payment Amount</p>
                                <p class="text-3xl font-bold text-blue-600">
                                    {% if application_details.payment_amount %}
                                        K{{ application_details.payment_amount|floatformat:0 }}
                                    {% else %}
                                        <span class="text-slate-400 text-base">Not calculated</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purpose & Collateral Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-green-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-bullseye text-green-600 mr-3"></i>
                        Purpose & Collateral
                    </h2>
                    <div class="space-y-6">
                        <div>
                            <p class="text-slate-600 text-sm font-semibold mb-3 uppercase tracking-wide">Loan Purpose</p>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                <p class="text-slate-900">{{ application_details.purpose }}</p>
                            </div>
                        </div>
                        {% if application_details.collateral_description %}
                        <div>
                            <p class="text-slate-600 text-sm font-semibold mb-3 uppercase tracking-wide">Collateral Description</p>
                            <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                                <p class="text-slate-900">{{ application_details.collateral_description }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if application_details.collateral_value %}
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                                <p class="text-green-700 text-xs font-semibold uppercase mb-1">Collateral Value</p>
                                <p class="text-2xl font-bold text-green-900">K{{ application_details.collateral_value|floatformat:0 }}</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                                <p class="text-blue-700 text-xs font-semibold uppercase mb-1">LTV Ratio</p>
                                <p class="text-2xl font-bold text-blue-900">
                                    {% widthratio application_details.principal_amount application_details.collateral_value 100 %}%
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Personal Information Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-purple-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-user text-purple-600 mr-3"></i>
                        Personal Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Full Name</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.personal.full_name }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Email</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.personal.email }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Phone</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.personal.phone_number }}</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Date of Birth</p>
                                <p class="text-lg font-semibold text-slate-900">
                                    {% if borrower_info.personal.date_of_birth %}
                                        {{ borrower_info.personal.date_of_birth|date:"F d, Y" }}
                                    {% else %}
                                        <span class="text-slate-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">National ID</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.personal.national_id|default:"Not provided" }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Verification</p>
                                <div class="inline-flex items-center px-3 py-1 rounded-lg text-sm font-semibold
                                    {% if borrower_info.personal.is_verified %}
                                        bg-green-100 text-green-800
                                    {% else %}
                                        bg-yellow-100 text-yellow-800
                                    {% endif %}">
                                    <i class="fas {% if borrower_info.personal.is_verified %}fa-check-circle{% else %}fa-clock{% endif %} mr-2"></i>
                                    {% if borrower_info.personal.is_verified %}Verified{% else %}Pending{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employment Information Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-orange-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-briefcase text-orange-600 mr-3"></i>
                        Employment Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Employment Status</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.employment.status }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Employer</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.employment.employer_name|default:"Not provided" }}</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Employment Duration</p>
                                <p class="text-lg font-semibold text-slate-900">
                                    {% if borrower_info.employment.employment_duration %}
                                        {{ borrower_info.employment.employment_duration }} years
                                    {% else %}
                                        <span class="text-slate-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Monthly Income</p>
                                <p class="text-2xl font-bold text-orange-600">
                                    {% if borrower_info.employment.monthly_income %}
                                        K{{ borrower_info.employment.monthly_income|floatformat:0 }}
                                    {% else %}
                                        <span class="text-slate-400 text-base">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Information (if applicable) -->
                {% if borrower_info.business.name %}
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-pink-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-store text-pink-600 mr-3"></i>
                        Business Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Business Name</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.business.name }}</p>
                            </div>
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Address</p>
                                <p class="text-lg font-semibold text-slate-900">{{ borrower_info.business.address|default:"Not provided" }}</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-slate-600 text-sm font-semibold mb-2 uppercase tracking-wide">Duration</p>
                                <p class="text-lg font-semibold text-slate-900">
                                    {% if borrower_info.business.duration %}
                                        {{ borrower_info.business.duration }} years
                                    {% else %}
                                        <span class="text-slate-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- References -->
                {% if borrower_info.references.reference1.name or borrower_info.references.reference2.name %}
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200 border-l-4 border-l-indigo-500">
                    <h2 class="text-2xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-users text-indigo-600 mr-3"></i>
                        References
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        {% if borrower_info.references.reference1.name %}
                        <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-200">
                            <h3 class="font-semibold text-slate-900 mb-4">Reference 1</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Name</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference1.name }}</p>
                                </div>
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Phone</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference1.phone|default:"Not provided" }}</p>
                                </div>
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Relationship</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference1.relationship|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if borrower_info.references.reference2.name %}
                        <div class="bg-indigo-50 rounded-lg p-6 border border-indigo-200">
                            <h3 class="font-semibold text-slate-900 mb-4">Reference 2</h3>
                            <div class="space-y-3">
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Name</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference2.name }}</p>
                                </div>
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Phone</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference2.phone|default:"Not provided" }}</p>
                                </div>
                                <div>
                                    <p class="text-indigo-700 text-xs font-semibold uppercase mb-1">Relationship</p>
                                    <p class="text-slate-900">{{ borrower_info.references.reference2.relationship|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Sidebar -->
            <div class="lg:col-span-1 space-y-8">
                <!-- Quick Summary Card -->
                <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-xl shadow-lg p-8 text-white border border-green-500">
                    <h3 class="text-xl font-bold mb-6 flex items-center">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Summary
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center pb-4 border-b border-green-500">
                            <span class="text-green-100">Principal</span>
                            <span class="text-2xl font-bold">K{{ application_details.principal_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center pb-4 border-b border-green-500">
                            <span class="text-green-100">Interest</span>
                            <span class="text-xl font-bold">{{ application_details.interest_rate }}%</span>
                        </div>
                        <div class="flex justify-between items-center pb-4 border-b border-green-500">
                            <span class="text-green-100">Payment</span>
                            <span class="text-xl font-bold">
                                {% if application_details.payment_amount %}
                                    K{{ application_details.payment_amount|floatformat:0 }}
                                {% else %}
                                    â€”
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-green-100">Status</span>
                            <span class="px-3 py-1 bg-white bg-opacity-20 rounded-lg text-sm font-semibold">{{ loan.get_status_display }}</span>
                        </div>
                    </div>
                </div>

                <!-- Borrower Profile Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-user-circle text-green-600 mr-2"></i>
                        Borrower
                    </h3>
                    <div class="flex flex-col items-center text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-green-100 to-green-50 rounded-full flex items-center justify-center mb-4 border-2 border-green-200">
                            <i class="fas fa-user text-green-600 text-2xl"></i>
                        </div>
                        <h4 class="text-lg font-bold text-slate-900">{{ borrower_info.personal.full_name }}</h4>
                        <p class="text-sm text-slate-600">{{ borrower_info.personal.email }}</p>
                    </div>
                    <div class="space-y-3 border-t border-slate-200 pt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-600 text-sm">Phone</span>
                            <span class="font-semibold text-slate-900">{{ borrower_info.personal.phone_number }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-slate-600 text-sm">Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-semibold
                                {% if borrower_info.personal.is_verified %}
                                    bg-green-100 text-green-800
                                {% else %}
                                    bg-yellow-100 text-yellow-800
                                {% endif %}">
                                {% if borrower_info.personal.is_verified %}
                                    <i class="fas fa-check-circle mr-1"></i>Verified
                                {% else %}
                                    <i class="fas fa-clock mr-1"></i>Pending
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-cogs text-blue-600 mr-2"></i>
                        Actions
                    </h3>
                    <div class="space-y-3">
                        <a href="{% url 'loans:detail' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-eye mr-2"></i>View Full Details
                        </a>
                        
                        {% if user.role == 'admin' or user.role == 'manager' or user.role == 'loan_officer' %}
                            {% if loan.status == 'pending' %}
                            <a href="{% url 'loans:approve' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-semibold shadow-md hover:shadow-lg">
                                <i class="fas fa-check-circle mr-2"></i>Approve
                            </a>
                            <a href="{% url 'loans:reject' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-semibold shadow-md hover:shadow-lg">
                                <i class="fas fa-times-circle mr-2"></i>Reject
                            </a>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{% url 'documents:upload' %}" class="w-full flex items-center justify-center px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 font-semibold shadow-md hover:shadow-lg">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Documents
                        </a>
                    </div>
                </div>

                <!-- Timeline Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center">
                        <i class="fas fa-history text-orange-600 mr-2"></i>
                        Timeline
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-green-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-900">Application Submitted</p>
                                <p class="text-xs text-slate-600">{{ loan.application_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% if loan.approval_date %}
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-green-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-900">Loan Approved</p>
                                <p class="text-xs text-slate-600">{{ loan.approval_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if loan.disbursement_date %}
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-green-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-semibold text-slate-900">Loan Disbursed</p>
                                <p class="text-xs text-slate-600">{{ loan.disbursement_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
