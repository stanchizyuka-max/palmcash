{% extends 'base_tailwind_enhanced.html' %}
{% load static %}
{% load humanize %}

{% block title %}Loan Application Details - {{ loan.application_number }} - Palm Cash{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Page Header with Breadcrumb -->
        <div class="mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-3">
                        <a href="{% url 'dashboard:dashboard' %}" class="hover:text-primary-600 transition-colors">Dashboard</a>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                        <a href="{% url 'loans:list' %}" class="hover:text-primary-600 transition-colors">Loans</a>
                        <i class="fas fa-chevron-right text-gray-400"></i>
                        <span class="text-gray-900 font-medium">Application Details</span>
                    </div>
                    <h1 class="text-4xl font-bold text-gray-900">Loan Application</h1>
                    <p class="text-gray-600 mt-2">Application #{{ loan.application_number }}</p>
                </div>
                <a href="{% url 'loans:detail' loan.pk %}" class="inline-flex items-center px-6 py-3 bg-white border-2 border-primary-600 text-primary-600 rounded-lg hover:bg-primary-50 transition-colors duration-200 font-medium shadow-sm">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Loan
                </a>
            </div>

            <!-- Status Bar -->
            <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 
                {% if loan.status == 'pending' %}border-yellow-500
                {% elif loan.status == 'approved' %}border-green-500
                {% elif loan.status == 'active' %}border-blue-500
                {% elif loan.status == 'rejected' %}border-red-500
                {% elif loan.status == 'completed' %}border-gray-500
                {% endif %}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center
                            {% if loan.status == 'pending' %}bg-yellow-100
                            {% elif loan.status == 'approved' %}bg-green-100
                            {% elif loan.status == 'active' %}bg-blue-100
                            {% elif loan.status == 'rejected' %}bg-red-100
                            {% elif loan.status == 'completed' %}bg-gray-100
                            {% endif %}">
                            <i class="fas fa-file-contract text-xl
                                {% if loan.status == 'pending' %}text-yellow-600
                                {% elif loan.status == 'approved' %}text-green-600
                                {% elif loan.status == 'active' %}text-blue-600
                                {% elif loan.status == 'rejected' %}text-red-600
                                {% elif loan.status == 'completed' %}text-gray-600
                                {% endif %}"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">Current Status</p>
                            <p class="text-2xl font-bold text-gray-900">{{ loan.get_status_display }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Applied on</p>
                        <p class="text-lg font-semibold text-gray-900">{{ loan.application_date|date:"M d, Y" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Loan Details Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-100 to-blue-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-file-contract text-blue-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Loan Details</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Application Number</p>
                                <p class="text-lg font-semibold text-gray-900">{{ loan.application_number }}</p>
                            </div>
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Loan Type</p>
                                <p class="text-lg font-semibold text-gray-900">{{ application_details.loan_type }}</p>
                            </div>
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Principal Amount</p>
                                <p class="text-2xl font-bold text-primary-600">K{{ application_details.principal_amount|floatformat:2 }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Interest Rate</p>
                                <p class="text-lg font-semibold text-gray-900">{{ application_details.interest_rate }}% per annum</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Repayment Frequency</p>
                                <p class="text-lg font-semibold text-gray-900">{{ application_details.repayment_frequency }}</p>
                            </div>
                            {% if application_details.term_days %}
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Loan Term</p>
                                <p class="text-lg font-semibold text-gray-900">{{ application_details.term_days }} days</p>
                            </div>
                            {% endif %}
                            {% if application_details.term_weeks %}
                            <div class="pb-6 border-b border-gray-100">
                                <p class="text-sm font-medium text-gray-600 mb-1">Loan Term</p>
                                <p class="text-lg font-semibold text-gray-900">{{ application_details.term_weeks }} weeks</p>
                            </div>
                            {% endif %}
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Payment Amount</p>
                                <p class="text-2xl font-bold text-primary-600">
                                    {% if application_details.payment_amount %}
                                        K{{ application_details.payment_amount|floatformat:2 }}
                                    {% else %}
                                        <span class="text-gray-400 text-base">Not calculated</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purpose & Collateral Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-green-100 to-green-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-bullseye text-green-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Purpose & Collateral</h2>
                    </div>
                    <div class="space-y-6">
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-2">Loan Purpose</p>
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <p class="text-gray-900">{{ application_details.purpose }}</p>
                            </div>
                        </div>
                        {% if application_details.collateral_description %}
                        <div>
                            <p class="text-sm font-medium text-gray-600 mb-2">Collateral Description</p>
                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                                <p class="text-gray-900">{{ application_details.collateral_description }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if application_details.collateral_value %}
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Collateral Value</p>
                                <p class="text-xl font-bold text-gray-900">K{{ application_details.collateral_value|floatformat:2 }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">LTV Ratio</p>
                                <p class="text-xl font-bold text-gray-900">
                                    {% widthratio application_details.principal_amount application_details.collateral_value 100 %}%
                                </p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Personal Information Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-purple-100 to-purple-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-user text-purple-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Personal Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Full Name</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.personal.full_name }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Email Address</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.personal.email }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Phone Number</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.personal.phone_number }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Date of Birth</p>
                                <p class="text-lg font-semibold text-gray-900">
                                    {% if borrower_info.personal.date_of_birth %}
                                        {{ borrower_info.personal.date_of_birth|date:"F d, Y" }}
                                    {% else %}
                                        <span class="text-gray-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">National ID</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.personal.national_id|default:"Not provided" }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Verification Status</p>
                                <div class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                    {% if borrower_info.personal.is_verified %}
                                        bg-green-100 text-green-700
                                    {% else %}
                                        bg-yellow-100 text-yellow-700
                                    {% endif %}">
                                    <i class="fas {% if borrower_info.personal.is_verified %}fa-check-circle{% else %}fa-clock{% endif %} mr-2"></i>
                                    {% if borrower_info.personal.is_verified %}Verified{% else %}Pending{% endif %}
                                </div>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Address</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.residential.address|default:"Not provided" }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Residential Duration</p>
                                <p class="text-lg font-semibold text-gray-900">
                                    {% if borrower_info.residential.duration %}
                                        {{ borrower_info.residential.duration }} years
                                    {% else %}
                                        <span class="text-gray-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Employment Information Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-orange-100 to-orange-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-briefcase text-orange-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Employment Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Employment Status</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.employment.status }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Employer Name</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.employment.employer_name|default:"Not provided" }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Employer Address</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.employment.employer_address|default:"Not provided" }}</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Employment Duration</p>
                                <p class="text-lg font-semibold text-gray-900">
                                    {% if borrower_info.employment.employment_duration %}
                                        {{ borrower_info.employment.employment_duration }} years
                                    {% else %}
                                        <span class="text-gray-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Monthly Income</p>
                                <p class="text-2xl font-bold text-primary-600">
                                    {% if borrower_info.employment.monthly_income %}
                                        K{{ borrower_info.employment.monthly_income|floatformat:2 }}
                                    {% else %}
                                        <span class="text-gray-400 text-base">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Business Information (if applicable) -->
                {% if borrower_info.business.name %}
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-pink-100 to-pink-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-store text-pink-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">Business Information</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Business Name</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.business.name }}</p>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Business Address</p>
                                <p class="text-lg font-semibold text-gray-900">{{ borrower_info.business.address|default:"Not provided" }}</p>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div>
                                <p class="text-sm font-medium text-gray-600 mb-1">Business Duration</p>
                                <p class="text-lg font-semibold text-gray-900">
                                    {% if borrower_info.business.duration %}
                                        {{ borrower_info.business.duration }} years
                                    {% else %}
                                        <span class="text-gray-400">Not provided</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- References -->
                {% if borrower_info.references.reference1.name or borrower_info.references.reference2.name %}
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100 hover:shadow-md transition-shadow duration-300">
                    <div class="flex items-center mb-6">
                        <div class="w-12 h-12 bg-gradient-to-br from-indigo-100 to-indigo-50 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-users text-indigo-600 text-xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-gray-900">References</h2>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {% if borrower_info.references.reference1.name %}
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <h3 class="font-semibold text-gray-900 mb-4">Reference 1</h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Name</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference1.name }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Phone</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference1.phone|default:"Not provided" }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Relationship</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference1.relationship|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if borrower_info.references.reference2.name %}
                        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                            <h3 class="font-semibold text-gray-900 mb-4">Reference 2</h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Name</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference2.name }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Phone</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference2.phone|default:"Not provided" }}</p>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-600 mb-1">Relationship</p>
                                    <p class="text-gray-900">{{ borrower_info.references.reference2.relationship|default:"Not provided" }}</p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Sidebar -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Quick Summary Card -->
                <div class="bg-gradient-to-br from-primary-600 to-primary-700 rounded-xl shadow-lg p-8 text-white">
                    <h3 class="text-xl font-bold mb-6">Application Summary</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center pb-4 border-b border-primary-500">
                            <span class="text-primary-100">Principal</span>
                            <span class="text-2xl font-bold">K{{ application_details.principal_amount|floatformat:0 }}</span>
                        </div>
                        <div class="flex justify-between items-center pb-4 border-b border-primary-500">
                            <span class="text-primary-100">Interest Rate</span>
                            <span class="text-xl font-bold">{{ application_details.interest_rate }}%</span>
                        </div>
                        <div class="flex justify-between items-center pb-4 border-b border-primary-500">
                            <span class="text-primary-100">Payment Amount</span>
                            <span class="text-xl font-bold">
                                {% if application_details.payment_amount %}
                                    K{{ application_details.payment_amount|floatformat:0 }}
                                {% else %}
                                    â€”
                                {% endif %}
                            </span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-primary-100">Status</span>
                            <span class="px-3 py-1 bg-white bg-opacity-20 rounded-full text-sm font-semibold">{{ loan.get_status_display }}</span>
                        </div>
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Actions</h3>
                    <div class="space-y-3">
                        <a href="{% url 'loans:detail' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 font-medium shadow-sm hover:shadow-md">
                            <i class="fas fa-eye mr-2"></i>View Full Loan Details
                        </a>
                        
                        {% if user.role == 'admin' or user.role == 'manager' or user.role == 'loan_officer' %}
                            {% if loan.status == 'pending' %}
                            <a href="{% url 'loans:approve' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors duration-200 font-medium shadow-sm hover:shadow-md">
                                <i class="fas fa-check-circle mr-2"></i>Approve Loan
                            </a>
                            <a href="{% url 'loans:reject' loan.pk %}" class="w-full flex items-center justify-center px-4 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors duration-200 font-medium shadow-sm hover:shadow-md">
                                <i class="fas fa-times-circle mr-2"></i>Reject Loan
                            </a>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{% url 'documents:upload' %}" class="w-full flex items-center justify-center px-4 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors duration-200 font-medium shadow-sm hover:shadow-md">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>Upload Documents
                        </a>
                    </div>
                </div>

                <!-- Borrower Profile Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Borrower Profile</h3>
                    <div class="flex flex-col items-center text-center mb-6">
                        <div class="w-16 h-16 bg-gradient-to-br from-primary-100 to-primary-50 rounded-full flex items-center justify-center mb-4 border-2 border-primary-200">
                            <i class="fas fa-user text-primary-600 text-2xl"></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900">{{ borrower_info.personal.full_name }}</h4>
                        <p class="text-sm text-gray-600">{{ borrower_info.personal.email }}</p>
                    </div>
                    <div class="space-y-3 border-t border-gray-100 pt-4">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Phone</span>
                            <span class="font-medium text-gray-900">{{ borrower_info.personal.phone_number }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-600">Status</span>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium
                                {% if borrower_info.personal.is_verified %}
                                    bg-green-100 text-green-700
                                {% else %}
                                    bg-yellow-100 text-yellow-700
                                {% endif %}">
                                {% if borrower_info.personal.is_verified %}
                                    <i class="fas fa-check-circle mr-1"></i>Verified
                                {% else %}
                                    <i class="fas fa-clock mr-1"></i>Pending
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Timeline Card -->
                <div class="bg-white rounded-xl shadow-sm p-8 border border-gray-100">
                    <h3 class="text-xl font-bold text-gray-900 mb-6">Timeline</h3>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-green-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Application Submitted</p>
                                <p class="text-xs text-gray-600">{{ loan.application_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% if loan.approval_date %}
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-green-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Loan Approved</p>
                                <p class="text-xs text-gray-600">{{ loan.approval_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                        {% if loan.disbursement_date %}
                        <div class="flex items-start">
                            <div class="w-3 h-3 bg-blue-600 rounded-full mt-2 mr-4 flex-shrink-0"></div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Loan Disbursed</p>
                                <p class="text-xs text-gray-600">{{ loan.disbursement_date|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
